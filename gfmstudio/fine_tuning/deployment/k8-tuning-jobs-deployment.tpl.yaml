# Â© Copyright IBM Corporation 2025
# SPDX-License-Identifier: Apache-2.0


---
apiVersion: v1
kind: ConfigMap
metadata:
  name: ${FTUNE_NAME}-config
  labels:
    app: ${FTUNE_NAME}
data:
  config-train.yaml: |
    ${TUNING_CONFIG_YAML}

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: ${FTUNE_NAME}-config-pvc
  labels:
    app: ${FTUNE_NAME}
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi

---
apiVersion: batch/v1
kind: Job
metadata:
  name: ${FTUNE_NAME}-job
  labels:
    app: ${FTUNE_NAME}
spec:
  completions: 1
  parallelism: 1
  backoffLimit: 0
  template:
    metadata:
      name: ${FTUNE_NAME}-pod
    spec:
      serviceAccountName: api-gateway-sa
      restartPolicy: Never
      imagePullSecrets:
        - name: ${IMAGE_PULL_SECRET}
      initContainers:
        - name: copy-config
          image: busybox
          command: ['sh', '-c', 'cp /config/config-train.yaml /app/config/']
          volumeMounts:
            - name: config-volume
              mountPath: /config
            - name: persistent-storage
              mountPath: /app/config
      volumes:
        - name: mount-data
          persistentVolumeClaim:
            claimName: gfm-ft-data-pvc
        - name: mount-models
          persistentVolumeClaim:
            claimName: gfm-ft-models-pvc
        - name: mount-geotunes
          persistentVolumeClaim:
            claimName: gfm-ft-files-pvc
        - name: dshm
          emptyDir:
            medium: Memory
        - name: config-volume
          configMap:
            name: ${FTUNE_NAME}-config
        - name: persistent-storage
          persistentVolumeClaim:
            claimName: ${FTUNE_NAME}-config-pvc
        - name: ftuning-script
          configMap:
            name: ftuning-script-${TUNE_ID}
            defaultMode: 0755
      containers:
        - name: terratorch-ft-test
          image: ${FTUNING_RUNTIME_IMAGE}
          resources:
            limits:
              cpu: '${RESOURCE_LIMIT_CPU}'
              memory: ${RESOURCE_LIMIT_Memory}G
              nvidia.com/gpu: '${RESOURCE_LIMIT_GPU}'
            requests:
              cpu: '${RESOURCE_REQUEST_CPU}'
              memory: ${RESOURCE_REQUEST_Memory}G
              nvidia.com/gpu: '${RESOURCE_REQUEST_GPU}'
          imagePullPolicy: Always
          volumeMounts:
            - name: mount-data
              mountPath: /ft-data
            - name: mount-models
              mountPath: /terratorch/gfm_models
            - name: mount-geotunes
              mountPath: /geotunes
            - name: dshm
              mountPath: /dev/shm
            - name: persistent-storage
              mountPath: /app/config
            - name: ftuning-script
              mountPath: /ftuning
          command: ["/bin/bash"]
          args: ["-c", "/ftuning/ftuning.sh"]
          env:
            - name: MLFLOW_TRACKING_INSECURE_TLS
              value: "true"
            - name: JOB_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
      tolerations:
        # - effect: NoSchedule
          # key: node-role.kubernetes.io/infra
          # key: node-role.kubernetes.io/master
        - operator: Exists

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: ftuning-script-${TUNE_ID}
data:
  ftuning.sh: |
    #!/bin/bash
    set -e

    # Function to handle errors
    error_handler() {
        local status=$?

        echo "An error occurred. Sending error notification..."
        echo "Notify FT with EVENT_ID:$FT_WEBHOOKS_ID and TUNE_ID: $TUNE_ID"

        curl -k -XPOST ${FT_WEBHOOKS_URL} \
            -H 'accept: application/json' \
            -H 'Content-Type: application/json' \
            -H 'X-API-KEY: ${FT_API_KEY}' \
            -d "{
            \"event_id\": \"$FT_WEBHOOKS_ID\",
            \"detail_type\": \"Ftune:Task:JobNotifications\",
            \"source\": \"com.ibm.ftuning\",
            \"timestamp\": \"$(date +%Y-%m-%dT%H:%M:%SZ)\",
            \"detail\": {\"status\": \"Failed\", \"tune_id\": \"$TUNE_ID\"}
            }"
        exit $status
    }

    # Function to send success notification
    success_handler() {
        echo "Job completed successfully. Sending success notification..."
        echo "Notify FT with EVENT_ID: $FT_WEBHOOKS_ID and TUNE_ID: $TUNE_ID"
        curl -k -XPOST ${FT_WEBHOOKS_URL} \
            -H 'accept: application/json' \
            -H 'Content-Type: application/json' \
            -H 'X-API-KEY: ${FT_API_KEY}' \
            -d "{
            \"event_id\": \"$FT_WEBHOOKS_ID\",
            \"detail_type\": \"Ftune:Task:JobNotifications\",
            \"source\": \"com.ibm.ftuning\",
            \"timestamp\": \"$(date +%Y-%m-%dT%H:%M:%SZ)\",
            \"detail\": {\"status\": \"Finished\", \"tune_id\": \"$TUNE_ID\"}
            }"
    }

    # Trap errors to call error_handler
    trap 'error_handler' ERR

    echo "Check Terratorch version before starting to tune..."
    echo $( python -m pip freeze | grep terratorch )
    echo

    
    echo "Running start tuning task..."
    sleep 5

    # Fine tuning command
    terratorch fit -c /app/config/config-train.yaml

    echo "Tuning task completed"

    if [ "$RUN_TERRATORCH_TEST" = "True" ]; then

      echo "Copying config-train.yaml to config-test.yaml"
      cp /geotunes/tune-tasks/$TUNE_ID/config-train.yaml /geotunes/tune-tasks/$TUNE_ID/config-test.yaml
      echo "Renaming run_name to "Test" in config-test.yaml logger"
      sed -i 's/\(run_name: \).*/\1"Test"/' /geotunes/tune-tasks/$TUNE_ID/config-test.yaml

      echo "Running terratorch test --config /geotunes/tune-tasks/$TUNE_ID/config-test.yaml --ckpt $(ls /geotunes/tune-tasks/$TUNE_ID/*epoch*.ckpt | head -n1)"
      terratorch test --config /geotunes/tune-tasks/$TUNE_ID/config-test.yaml --ckpt $(ls /geotunes/tune-tasks/$TUNE_ID/*epoch*.ckpt | head -n1)
      echo "Tuning test completed"

      echo "Removing value verbose:true in config_deploy.yaml config"
      sed -i '/^verbose: true$/d' /geotunes/tune-tasks/$TUNE_ID/config_deploy.yaml
    fi

    # Call success handler if no errors occurred
    success_handler
    echo "Job ${FTUNE_NAME}-job , PVC ${FTUNE_NAME}-config-pvc , ConfigMap ${FTUNE_NAME}-config, ftuning-script-${TUNE_ID} created in $NAMESPACE. Fine-tuning completed"
